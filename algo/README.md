## ACTIN-Algo

ACTIN-Algo matches a patient record (clinical & molecular data) with available treatments.

This application requires Java 11+ and can be run as follows: 

```
java -cp actin.jar com.hartwig.actin.algo.TreatmentMatcherApplication \
   -clinical_json /path/to/clinical.json \
   -molecular_json /path/to/molecular.json \
   -treatment_database_directory /path/to/potential_treatment_options \
   -doid_json /path/to/full_doid_tree_json_file \
   -output_directory /path/where/output/is/written \
```

The following assumptions are made about the inputs:
 - The clinical JSON adheres to the format that is generated by [ACTIN-Clinical](../clinical/README.md)
 - The molecular JSON is the [ORANGE](https://github.com/hartwigmedical/hmftools/blob/master/orange/README.md) 
 output from the [Hartwig platinum pipeline](https://github.com/hartwigmedical/platinum)
 - The treatment database directory is the output directory of [ACTIN-Treatment](../treatment/README.md)
 
### Treatment matching

Every treatment defined in the treatment database is evaluated independently. 

In case a treatment is a trial, all relevant inclusion and exclusion criteria are evaluated for this trial as well as every criterion 
for any specific cohort within this trial.  

Every criterion evaluates to one of the following options:

Evaluation | Description
---|---
PASS | The patient complies with the inclusion or exclusion criterion.  
PASS_BUT_WARN | The patient complies with the inclusion or exclusion criterion but a manual check is required.
FAIL | The patient does not comply with the inclusion or exclusion criterion. 
UNDETERMINED | The data provided to the inclusion or exclusion criterion is insufficient for determining eligibility.
NOT_EVALUATED | The evaluation of the inclusion or exclusion criterion is skipped and can be assumed to be irrelevant for determining trial eligibility. 
NOT_IMPLEMENTED | No algo has been defined yet for this criterion.

For every trial (and cohort) an overall evaluation is determined using the following algorithm:
 1. A patient is eligible for a trial (or cohort) only in case all criteria are `PASS`, `PASS_BUT_WARN` or `NOT_EVALUATED`
 1. In case one of the criteria evaluates to a `FAIL` the patient fails overall eligibility for the trial (or cohort). 
 1. In case of no fails but at least one `UNDETERMINED` or `NOT_IMPLEMENTED` evaluation, the overall evaluation is determined 
 to be `UNDETERMINED`.    

The following additional rules are applied for trials versus cohorts:
 1. A patient is eligible for a specific cohort only if the overall evaluation for both the cohort as well as the trial itself are passed.
 1. A patient is eligible for a trial only if it is eligible for at least one of the cohorts within the trial or if the trial has no 
 cohorts defined and the patient passes all criteria for the trial.  

#### Individual criteria algorithms

Inclusion and exclusion criteria can be defined as a set of rules that are combined using composite functions, to determine overall eligibility. 

The following composite functions are available:

Function | Description 
---|---
AND | indicates that all combined rules should be TRUE in order to PASS
OR | indicates that either of combined rules should be TRUE in order to PASS
NOT | indicates that the rule should not be TRUE in order to PASS
WARN_ON_PASS | indicates that a warning should be displayed in case of PASS and resolves to PASS_BUT_WARN

Some rules require 1 ("X") or 2 ("X" and "Y") additional configuration parameter(s) that can be set to match the requirements of each trial. 
Also, note that some inclusion and exclusion criteria can be mapped to rules that are currently explicitly set to PASS or explicitly 
won't be evaluated. 

The following rules are available:

##### Rules related to general patient characteristics

Rule | When does a patient pass evaluation? | Note
---|---|---
IS_AT_LEAST_18_YEARS_OLD | Current year minus birth year > 18 | PASS_BUT_WARN in case of exactly 18
HAS_WHO_STATUS_OF_AT_MOST_X | WHO <= X
IS_ABLE_AND_WILLING_TO_GIVE_ADEQUATE_INFORMED_CONSENT | > won't be evaluated
IS_INVOLVED_IN_STUDY_PROCEDURES | > won't be evaluated
HAS_LIFE_EXPECTANCY_OF_AT_LEAST_X_WEEKS | > won't be evaluated
HAS_LIFE_EXPECTANCY_OF_AT_LEAST_X_MONTHS | > won't be evaluated

##### Rules related to tumor and lesion locations
 
Rule | When does a patient pass evaluation?
---|---
PRIMARY_TUMOR_LOCATION_BELONGS_ TO_DOID_X | Configured DOID should be equal or be a child of DOID X
HAS_ADVANCED_CANCER | Tumor details > stage III or IV
HAS_METASTATIC_CANCER | Tumor details > stage IV 
HAS_LIVER_METASTASES | Tumor details > hasLiverLesions = 1
HAS_KNOWN_CNS_METASTASES | Tumor details > hasCnsLesions = 1
HAS_KNOWN_ACTIVE_CNS_METASTASES | Tumor details > hasActiveCnsLesions = 1
HAS_KNOWN_SYMPTOMATIC_CNS_METASTASES | Tumor details > hasSymptomaticCnsLesions = 1
HAS_KNOWN_BRAIN_METASTASES | Tumor details > hasBrainLesions = 1
HAS_KNOWN_ACTIVE_BRAIN_METASTASES | Tumor details > hasActiveBrainLesions = 1
HAS_KNOWN_SYMPTOMATIC_BRAIN_METASTASES | Tumor details > hasSymptomaticBrainLesions = 1
HAS_BONE_METASTASES | Tumor details > hasBoneLesions = 1
HAS_MEASURABLE_DISEASE_RECIST | Tumor details > hasMeasurableDiseaseRecist = 1 
HAS_BIOPSY_AMENABLE_LESION | Presence of WGS details (to be extended)
HAS_COLLECTED_TUMOR_BIOPSY_WITHIN_X_MONTHS_BEFORE_IC | Presence of WGS details (to be extended)

##### Rules related to previous cancer treatments or previous primary tumors

Rule | When does a patient pass evaluation? | Note
---|---|---
HAS_EXHAUSTED_SOC_TREATMENTS | T.B.D 
HAS_DECLINED_SOC_TREATMENTS | T.B.D
HAS_HISTORY_OF_SECOND_MALIGNANCY | Prior second primaries is not empty
HAS_HISTORY_OF_SECOND_MALIGNANCY_ BELONGING_TO_DOID_X | Presence of prior second primary belonging to DOID X
HAS_HISTORY_OF_SECOND_MALIGNANCY_ BELONGING_TO_DOID_X_CURRENTLY_INACTIVE | Presence of prior second primary belonging to DOID X, and status is inactive
EVERY_SECOND_MALIGNANCY_HAS_BEEN_ CURED_SINCE_X_YEARS | Prior second primaries is empty OR every prior second primary is inactive | Years can often not be reliably evaluated; rule will be combined with WARN_ON_PASS
HAS_HAD_AT_MOST_X_SYSTEMIC_ TREATMENT_LINES | Prior tumor treatments > nr of lines in case systemic = 1 <= X
HAS_HAD_DRUG_NAME_X_TREATMENT | Prior tumor treatmens > name contains X
HAS_HAD_TYPE_X_TREATMENT | Prior tumor treatments > categories contains X | "X" is one of: Chemotherapy, Hormone therapy, Immunotherapy, Targeted therapy, Radiotherapy, Surgery
HAS_HAD_TARGETED_THERAPY_TREATMENT_FOR_GENE_X | Prior tumor treatments > targetedType contains "X"
HAS_HAD_FLUOROPYRIMIDINE_TREATMENT | Prior tumor treatments > name contains any fluoropyrimidine | Fluoropyrimidines: Capecitabine, Carmofur, Doxifluridine, Fluorouracil, Tegafur (T.B.D.)
HAS_HAD_MAX_X_NR_ANTI_PD_L1_ OR_PD_1_IMMUNOTHERAPIES | Prior tumor treatments > nr of lines with immunoType Anti-PD-1 or Anti-PD-L1 should be <= X
HAS_HAD_STEM_CELL_TRANSPLANTATION | Prior tumor treatments > category = stem cell transplantation
IS_ELIGIBLE_FOR_ON_LABEL_DRUG_X | Drug X is in the SOC treatment DB for that tumor type (T.B.I.)

##### Rules related to molecular results

Rule | When does a patient pass evaluation?
---|---
MOLECULAR_RESULTS_MUST_BE_AVAILABLE | Ingestion of ORANGE results (later to be extended)
ACTIVATION_OF_GENE_X | Driver is found in gene X
INACTIVATION_OF_GENE_X | Driver is found in gene X
ACTIVATING_MUTATION_IN_GENE_X | Driver mutation is found in gene X
MUTATION_IN_GENE_X_OF_TYPE_Y | Driver mutation Y is found in gene X
INACTIVATING_MUTATION_IN_GENE_X | Driver mutation is found in gene X
AMPLIFICATION_OF_GENE_X | Amplification is found in gene X
DELETION_OF_GENE_X | Deletion/Homozygous disruption is found in gene X
ACTIVATING_FUSION_IN_GENE_X | Driver fusion with fusion partner gene X is found 
SPECIFIC_FUSION_X | Driver fusion with 2 specified fusion partner genes is found
OVEREXPRESSION_OF_GENE_X | > won't be evaluated
WILDTYPE_OF_GENE_X | No driver mutation is found in gene X
MSI_SIGNATURE | MS Status = MSI
HRD_SIGNATURE | HR Status = HRD
TMB_OF_AT_LEAST_X | Tumor Mutational Burden (TMB) should be => X
TML_OF_AT_LEAST_X | Tumor Mutational Load (TML) should be => X
TML_OF_AT_MOST_X | TML should be <= X

##### Rules related to recent laboratory measurements

Rule | When does a patient pass evaluation?
---|---
HAS_LEUKOCYTES_ABS_OF_AT_LEAST_X | Leukocytes absolute (LEUKO-ABS) => X
HAS_LEUKOCYTES_ABS_LLN_OF_AT_LEAST_X | Leukocytes absolute (LEUKO-ABS) => X*LLN
HAS_NEUTROPHILS_ABS_OF_AT_LEAST_X | Neutrophil granulocytes absolute (NEUTRO-ABS/NEUTRO-ABS-eDA) => X 
HAS_THROMBOCYTES_ABS_OF_AT_LEAST_X | Thrombocytes absolute (THROMBO-ABS) => X 
HAS_ALBUMIN_G_PER_DL_OF_AT_LEAST_X | Albumin (ALB) in g/dL => X. In case ALB is measured in g/L, the value is converted using ALB[g/dL]=ALB[g/L]/10.
HAS_HEMOGLOBIN_G_PER_DL_OF_AT_LEAST_X | Hemoglobin (Hb) in g/dL => X. In case Hb is measured in mmol/L, the value is converted to g/dL using Hb[g/dL]=Hb[mmol/L]/0.6206
HAS_HEMOGLOBIN_MMOL_PER_L_OF_AT_LEAST_X | Hemoglobin (Hb) in mmol/L => X. In case Hb is measured in g/dL, the value is converted to mmol/L using Hb[mmol/L]=Hb[g/dL]*0.6206
HAS_CREATININE_ULN_OF_AT_MOST_X | Creatinine (CREA) <= X*ULN (upper limit of normal, implemented as refLimitUp)
HAS_EGFR_CKD_EPI_OF_AT_LEAST_X | eGFR (CKD-EPI formula) => X. In case CrCl is measured in another unit, the value is converted using
HAS_EGFR_MDRD_OF_AT_LEAST_X | eGFR (MDRD formula) => X. In case CrCl is measured in another unit, the value is converted using
HAS_CREATININE_CLEARANCE_CG_OF_AT_LEAST_X | Creatinine clearance (Cockcroft Gault formula) => X. In case CrCl is measured in another unit, the value is converted using
HAS_TOTAL_BILIRUBIN_ULN_OF_AT_MOST_X | Total Bilirubin (TBIL) <= X*ULN 
HAS_DIRECT_BILIRUBIN_ULN_OF_AT_MOST_X | Direct Bilirubin (DBIL) <= X*ULN 
HAS_INR_ULN_OF_AT_MOST_X | International normalized ratio (INR) <= X*ULN 
HAS_PT_ULN_OF_AT_MOST_X | Prothrombin time (PT) <= X*ULN 
HAS_APTT_ULN_OF_AT_MOST_X | Activated partial thromboplastin time (APTT) <= X*ULN 
HAS_ASAT_ULN_OF_AT_MOST_X | Aspartate aminotransferase (ASAT) <= X*ULN 
HAS_ALAT_ULN_OF_AT_MOST_X | Alanine aminotransferase (ALAT) <= X*ULN
HAS_ALP_ULN_OF_AT_MOST_X | Alkaline phosphatase (ALP) <= X*ULN
HAS_POTASSIUM_WITHIN_INSTITUTIONAL_ NORMAL_LIMITS | Potassium (K) LLN<X<ULN (LLN: lower limit of normal, implemented as refLimitLow) (isOutsideRef=0)
HAS_MAGNESIUM_WITHIN_INSTITUTIONAL_ NORMAL_LIMITS | Magnesium (MG) LLN<X<ULN (isOutsideRef=0)

Note: for all lab values, the latest available lab value is evaluated. 
If the latest lab value is out of the requested range, the second-last lab value is evaluated (if available). 
In case that the second-last lab value is available AND within requested range, the evaluation resolves to UNDETERMINED. In case no second-last value is available, 
or that value is also out of requested range, the evaluation resolves to FAIL.

##### Rules related to other conditions

Rule | When does a patient pass evaluation?
---|---
HAS_SIGNIFICANT_CONCOMITANT_ILLNESS | Prior other conditions > is not empty
HAS_HISTORY_OF_AUTOIMMUNE_DISEASE | Prior other conditions > any configured doid should be equal or be a child of DOID 417
HAS_HISTORY_OF_CARDIAC_DISEASE | Prior other conditions > any configured doid should be equal or be a child of DOID 114
HAS_HISTORY_OF_CARDIOVASCULAR_DISEASE | Prior other conditions > any configured doid should be equal or be a child of DOID 1287
HAS_HISTORY_OF_VASCULAR_DISEASE | Prior other conditions > any configured doid should be equal or be a child of DOID 178
HAS_HISTORY_OF_LUNG_DISEASE | Prior other conditions > any configured doid should be equal or be a child of DOID 850
HAS_HISTORY_OF_STROKE | Prior other conditions > any configured doid should be equal or be a child of DOID 6713 
HAS_HISTORY_OF_TIA | Prior other conditions > any configured doid should be equal or be a child of DOID 224 
HAS_HAD_ORGAN_TRANSPLANT | Prior other conditions > categories contains "Organ transplant"
HAS_GILBERT_DISEASE | Prior other conditions > any configured doid should be equal or be a child of DOID 2739
HAS_CARDIAC_ARRHYTHMIA | Clinical status > hasSigAberrationLatestEcg = 1
HAS_HYPERTENSION | Prior other conditions > any configured doid should be equal or be a child of DOID 10763
HAS_DIABETES | Prior other conditions > any configured doid should be equal or be a child of DOID 9351
HAS_LVEF_OF_AT_LEAST_X | clinicalStatus > lvef should be => x. Unavailable LVEF data leads to UNDETERMINED, out of range LVEF leads to FAIL
HAS_LVEF_OF_AT_LEAST_X_IF_KNOWN | clinicalStatus > lvef should be => X. Unavailable LVEF data leads to PASS, out of range LVEF leads to FAIL
HAS_KNOWN_MALABSORPTION_SYNDROME | T.B.D.
IS_IN_DIALYSIS | > won't be evaluated

##### Rules related to infections

Rule | When does a patient pass evaluation?
---|---
HAS_ACTIVE_INFECTION | Clinical status > hasActiveInfection = 1
HAS_KNOWN_HEPATITIS_B_INFECTION | Prior other conditions > configured doid should be equal or be a child of DOID 2043
HAS_KNOWN_HEPATITIS_C_INFECTION | Prior other conditions > configured doid should be equal or be a child of DOID 1883
HAS_KNOWN_HIV_INFECTION | Prior other conditions > configured doid should be equal or be a child of DOID 526
HAS_KNOWN_CYTOMEGALOVIRUS_INFECTION |  Prior other conditions > configured doid should be equal or be a child of DOID 0080827

##### Rules related to current medication

Rule | When does a patient pass evaluation?| Note
---|---|---
HAS_ALLERGY_RELATED_TO_STUDY_MEDICATION | Allergy > Category = medication AND clinicalStatus = active | Exact ingredients cannot yet be automatically evaluated
IS_ABLE_TO_SWALLOW_ORAL_MEDICATION | > won't be evaluated
CURRENTLY_GETS_OTHER_ANTI_CANCER_THERAPY | > won't be evaluated
CURRENTLY_GETS_ANTICOAGULANT_MEDICATION | Medication > type is type of "Anticoagulants"
CURRENTLY_GETS_ANTIBIOTICS_MEDICATION | Medication > type is type of "Antibiotics"
CURRENTLY_GETS_CORTICOSTEROID_MEDICATION | Medication > type is type of "Corticosteroids"
CURRENTLY_GETS_COUMADIN_DERIVATIVE_MEDICATION | Medication > type is type of "Vitamin K Antagonists"
CURRENTLY_GETS_IMMUNOSUPPRESSANT_MEDICATION | T.B.D.
CURRENTLY_GETS_MEDICATION_INHIBITING_OR_ INDUCING_ISOENZYME_X | T.B.D.
HAS_STABLE_ANTICOAGULANT_DOSING | Medication > type is type of anticoagulants AND only 1 distinct dosage

##### Rules related to pregnancy/anticonception

Rule | When does a patient pass evaluation?
---|---
IS_BREASTFEEDING | > won't be evaluated
IS_PREGNANT | > won't be evaluated
IS_ABLE_AND_WILLING_TO_USE_ADEQUATE_ ANTICONCEPTION_IF_REQUIRED | > won't be evaluated

##### Rules related to toxicity

Rule | When does a patient pass evaluation? | Note
---|---|---
HAS_TOXICITY_OF_AT_LEAST_GRADE_X | Toxicities > grade => X. 
HAS_TOXICITY_OF_AT_LEAST_GRADE_X_IN_Y | Toxicities > grade => X and name like %Y%
HAS_TOXICITY_OF_AT_LEAST_GRADE_X_IGNORING_Y | Toxicities > grade => X and ignoring name like %Y%. | Multiple names can be specified within 1 rule, separated by ";"

Note for all toxicity rules: In case X = 0, 1 or 2, all names corresponding to 'source = Questionnaire' are included (also if 'grade' is unknown), since toxicities are only noted in questionnaire when grade => 2.
In case X = 3 or 4, the evaluation resolves to 'undetermined' if there are names for which grade is not specified.

##### Rules related to blood pressure measurements

Rule | When does a patient pass evaluation?
---|---
HAS_SBP_MMHG_OF_AT_LEAST_X | Blood pressures > category = Up to 5 most recent systolic blood pressure AND average value => X
HAS_DBP_MMHG_OF_AT_LEAST_X | Blood pressures > category = Up to 5 most recent diastolic blood pressure AND average value => X

##### Rules related to blood transfusions

Rule | When does a patient pass evaluation?
---|---
HAS_HAD_ERYTHROCYTE_TRANSFUSION_ WITHIN_LAST_X_WEEKS | Blood transfusions > product = Erythrocyte concentrate AND current date minus transfusion date <= X weeks
HAS_HAD_THROMBOCYTE_TRANSFUSION_ WITHIN_LAST_X_WEEKS | Blood transfusions > product = Thrombocyte concentrate AND current date minus transfusion date <= X weeks

##### Rules related to surgery

Rule | When does a patient pass evaluation?
---|---
HAS_HAD_SURGERY_WITHIN_LAST_X_WEEKS | Surgeries > Current date minus latest surgery date <= X weeks

##### Rules related to hospital

Rule | When does a patient pass evaluation? 
---|---
PATIENT_IS_TREATED_IN_HOSPITAL_X | Sample ID -> Hospital information > hospital should be hospital X
 
### Disease Ontology ID (DOID)
 
For rules about e.g. primary tumor location and type, second primaries and 'other conditions', one or more DOIDs may be implemented. For more information, see https://disease-ontology.org/.
 
### Version History and Download Links
 - Upcoming (first release) 